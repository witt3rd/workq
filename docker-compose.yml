# Animus Appliance
#
# Usage:
#   docker compose up -d                          # start (default instance: dev)
#   ANIMUS_INSTANCE=kelly docker compose up -d    # named instance
#
# Data lives at: ${ANIMUS_HOME}/data/${ANIMUS_INSTANCE}/
# Default: ~/.animus/data/dev/
#
# Port mappings controlled via env vars (set to empty to disable):
#   ANIMUS_PG_PORT=5432         (default: 5432, for cargo test from host)
#   ANIMUS_GRAFANA_PORT=3000    (default: 3000, for browser access)
#   ANIMUS_OTEL_GRPC_PORT=4317  (default: 4317, for host OTel export)
#   ANIMUS_OTEL_HTTP_PORT=4318  (default: 4318)
#
# Multiple instances: use different ports or disable host mappings.

services:
  postgres:
    build: ./docker
    environment:
      POSTGRES_USER: animus
      POSTGRES_PASSWORD: animus_dev
      POSTGRES_DB: animus_dev
    ports:
      - "${ANIMUS_PG_PORT:-5432}:5432"
    volumes:
      - ${ANIMUS_HOME:-~/.animus}/data/${ANIMUS_INSTANCE:-dev}/postgres:/var/lib/postgresql/data
      - ./docker/init-extensions.sql:/docker-entrypoint-initdb.d/01-extensions.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U animus"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  tempo:
    image: grafana/tempo:2.7.2
    command: ["-config.file=/etc/tempo/tempo.yml"]
    volumes:
      - ./docker/tempo.yml:/etc/tempo/tempo.yml
      - ${ANIMUS_HOME:-~/.animus}/data/${ANIMUS_INSTANCE:-dev}/tempo:/var/tempo

  loki:
    image: grafana/loki:latest
    command: ["-config.file=/etc/loki/loki.yml"]
    volumes:
      - ./docker/loki.yml:/etc/loki/loki.yml
      - ${ANIMUS_HOME:-~/.animus}/data/${ANIMUS_INSTANCE:-dev}/loki:/loki

  prometheus:
    image: prom/prometheus:latest
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver"
      - "--web.enable-admin-api"
      - "--storage.tsdb.retention.time=30d"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml
      - ${ANIMUS_HOME:-~/.animus}/data/${ANIMUS_INSTANCE:-dev}/prometheus:/prometheus

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otelcol/config.yml"]
    volumes:
      - ./docker/otel-collector.yml:/etc/otelcol/config.yml
    ports:
      - "${ANIMUS_OTEL_GRPC_PORT:-4317}:4317"
      - "${ANIMUS_OTEL_HTTP_PORT:-4318}:4318"
    depends_on:
      - tempo
      - loki
      - prometheus

  grafana:
    image: grafana/grafana:latest
    volumes:
      - ./docker/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
      - ./docker/grafana/alerting:/etc/grafana/provisioning/alerting
      - ${ANIMUS_HOME:-~/.animus}/data/${ANIMUS_INSTANCE:-dev}/grafana:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    ports:
      - "${ANIMUS_GRAFANA_PORT:-3000}:3000"
    depends_on:
      - tempo
      - loki
      - prometheus
